<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QuoteFeed — Serverless</title>

  <!-- Favicon (Option A: local file; place /icon.png in your site root) -->
  <link rel="icon" type="image/png" href="icon.png" />
  <!-- Favicon (Option B: built-in SVG fallback so you have an icon even with no file) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%237c4dff"/><stop offset="1" stop-color="%2300d4ff"/></linearGradient></defs><rect width="64" height="64" rx="14" fill="url(%23g)"/><text x="50%" y="56%" text-anchor="middle" font-size="34" font-family="Poppins,Arial" fill="white">Q</text></svg>' />

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e0f14;--text:#e8eaf0;--muted:#b7bfd6;
      --card:rgba(255,255,255,.07);--card-border:rgba(255,255,255,.12);
      --brand-1:#7c4dff;--brand-2:#00d4ff;--shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;--header-alpha1:.35;--header-alpha2:.25;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);
      background:radial-gradient(1200px 800px at 20% -10%,#1a1630 0%,transparent 60%),
                 radial-gradient(1000px 700px at 120% 10%,#05243a 0%,transparent 65%),
                 var(--bg);
      overflow-x:hidden
    }
    .blob{position:fixed;filter:blur(60px);opacity:.45;z-index:0;pointer-events:none;mix-blend-mode:screen;animation:float 15s ease-in-out infinite alternate}
    .blob.one{width:420px;height:420px;top:-60px;left:-60px;background:radial-gradient(circle at 30% 30%, #6b9bff, transparent 60%)}
    .blob.two{width:520px;height:520px;right:-100px;top:10vh;background:radial-gradient(circle at 40% 40%, #00e5ff, transparent 60%);animation-delay:1.5s}
    .blob.three{width:400px;height:400px;left:10vw;bottom:-80px;background:radial-gradient(circle at 40% 40%, #b388ff, transparent 60%);animation-delay:.7s}
    @keyframes float{from{transform:translateY(0) translateX(0) scale(1)}to{transform:translateY(20px) translateX(10px) scale(1.05)}}

    header{
      position:sticky;top:0;z-index:5;backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(90deg, rgba(124,77,255,var(--header-alpha1)), rgba(0,212,255,var(--header-alpha2))) border-box;
      border-bottom:1px solid rgba(255,255,255,.12);box-shadow:0 6px 24px rgba(0,0,0,.25)
    }
    .header-inner{
      max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:16px
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px}
    .brand .logo{width:30px;height:30px;border-radius:10px;background:conic-gradient(from 180deg at 50% 50%,var(--brand-1),var(--brand-2));box-shadow:0 6px 18px rgba(0,212,255,.35)}
    .spacer{flex:1}
    .countdown{font-weight:700; font-size:.95rem; opacity:.95; text-align:center}
    .clock{font-weight:600; font-variant-numeric:tabular-nums; opacity:.9}
    .header-actions{display:flex; align-items:center; gap:10px}
    .iconbtn{
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08);
      color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700; transition:.2s
    }
    .iconbtn:hover{background:rgba(255,255,255,.12)}

    .container{max-width:980px;margin:24px auto 90px;padding:0 16px;position:relative;z-index:1}

    .post{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--card-border); border-radius:var(--radius); overflow:hidden;
      box-shadow:var(--shadow); margin:24px 0; transform:translateZ(0); transition:transform .2s, box-shadow .2s
    }
    .post:hover{transform:translateY(-4px); box-shadow:0 16px 40px rgba(0,0,0,.45)}
    .post-header{display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .username{font-weight:700}
    .handle{color:var(--muted); font-weight:600; font-size:.9rem; margin-left:6px}
    .post img{width:100%; display:block; background:#0b0d12; aspect-ratio:16/9; object-fit:cover}
    .post-quote{padding:14px 16px 18px; color:#dce3ff; font-style:italic}

    .fab{
      position:fixed; right:24px; bottom:24px; z-index:6; border:none; border-radius:999px; padding:14px 20px;
      font-weight:700; color:#0a0a0f; background:linear-gradient(135deg, var(--brand-2), var(--brand-1));
      box-shadow:0 12px 28px rgba(0,0,0,.5); cursor:pointer; transition:transform .15s, box-shadow .2s, filter .2s
    }
    .fab:hover{transform:translateY(-2px); filter:saturate(115%); box-shadow:0 16px 36px rgba(0,0,0,.55)}

    .modal-backdrop{position:fixed; inset:0; z-index:20; background:rgba(0,0,0,.6); backdrop-filter:blur(6px); display:none; align-items:center; justify-content:center; padding:20px}
    .modal{width:100%; max-width:560px; background:linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.06));
      border:1px solid var(--card-border); border-radius:18px; box-shadow:0 24px 60px rgba(0,0,0,.65); overflow:hidden}
    .modal-head{padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between}
    .modal-body{padding:16px 18px 20px; display:grid; gap:12px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .input{width:100%; color:var(--text); background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:12px 14px; outline:none; font:inherit}
    .file{position:relative; overflow:hidden; display:inline-block; border:1px dashed rgba(255,255,255,.25); border-radius:12px; padding:12px; text-align:center; cursor:pointer}
    .file input[type=file]{position:absolute; inset:0; opacity:0; cursor:pointer}
    .preview{width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.18); display:none}
    .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:8px}
    .btn{border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.08); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700; transition:.2s}
    .btn:hover{background:rgba(255,255,255,.12)} .btn.primary{border-color:transparent; background:linear-gradient(135deg, var(--brand-2), var(--brand-1)); color:#071018}

    /* Settings modal */
    .settings-grid{display:grid; gap:12px}
    .swatches{display:flex; flex-wrap:wrap; gap:10px}
    .swatch{width:34px; height:34px; border-radius:8px; border:2px solid rgba(255,255,255,.25); cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.3)}

    /* Duplicate suggestion box */
    .dup-box{
      display:none; border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:12px;
      background:rgba(255,255,255,.06)
    }
    .dup-box h4 { margin:0 0 8px 0; }
    .dup-box img { width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.18); margin-bottom:10px; }

    /* Skeleton */
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06)); background-size:200% 100%; animation:shimmer 1.3s infinite; border-radius:10px}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .post.skel .post-header,.post.skel .post-quote{padding:14px 16px}.post.skel .img{height:min(52vw,360px)}

    /* Toasts */
    .toasts{position:fixed; right:16px; bottom:16px; z-index:50; display:flex; flex-direction:column; gap:10px}
    .toast{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); color:var(--text); padding:12px 14px; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.45); animation:pop .18s ease-out}
    @keyframes pop{from{transform:translateY(6px); opacity:0} to{transform:translateY(0); opacity:1}}

    footer{text-align:center;color:var(--muted);padding:32px 16px;margin-top:40px}
  </style>
</head>
<body>
  <!-- CONFIG: your values -->
  <script>
    const CONFIG = {
      SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrsMK1Vukh4XdPBeLgqE9mJ5s3wJW2H6BsaRgk_OFp2f7OLn-dq-2vipVV5uu7cZEP2NSfdHiuGrij/pub?output=csv",
      FORM_ACTION: "https://docs.google.com/forms/d/e/1FAIpQLSdXSX9ycneKk2q5O5sCYKGd9mRf7aVL_VRZgFpMYPfwR4QWKA/formResponse",
      FORM_FIELDS: {
        image_url: "entry.1771642195", // Image URL
        quote:     "entry.1351163377", // Quote
        username:  "entry.448940465"   // Username
      },
      CLOUDINARY: { cloudName: "djjpw13y9", uploadPreset: "quotefeed_unsigned" },
      DUP_HAMMING_THRESHOLD: 6 // <=6 considered "similar"
    };
  </script>

  <!-- soft blobs -->
  <div class="blob one"></div><div class="blob two"></div><div class="blob three"></div>

  <header>
    <div class="header-inner">
      <div class="brand"><div class="logo" aria-hidden="true"></div><div>QuoteFeed</div></div>
      <div class="spacer"></div>
      <div class="countdown" id="countdown">TIME TILL COMMERCE COMMEMORATION DAY — …</div>
      <div class="spacer"></div>
      <div class="header-actions">
        <div class="clock" id="clock">--:--:--</div>
        <button class="iconbtn" id="settingsBtn">⚙ Settings</button>
      </div>
    </div>
  </header>

  <div class="container"><div id="posts"></div></div>

  <button class="fab" id="fab">＋ New Post</button>

  <!-- New Post Modal -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-head">
        <strong>Create Post</strong>
        <button class="btn" id="closeModal" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <input id="username" class="input" type="text" placeholder="Username (e.g. naturelover)" />
          <input id="quote" class="input" type="text" placeholder="Quote (e.g. Enjoying the first light…)" />
        </div>
        <label class="file">
          <input id="imageFile" type="file" accept="image/*" />
          <span>Choose an image</span>
        </label>
        <img id="preview" class="preview" alt="Preview">

        <!-- Duplicate suggestion -->
        <div class="dup-box" id="dupBox">
          <h4>Looks like this image (or very similar) already exists. Use it?</h4>
          <img id="dupPreview" alt="Existing similar image">
          <div class="actions">
            <button class="btn" id="dupCancel">Cancel</button>
            <button class="btn primary" id="dupUse">Use this?</button>
          </div>
        </div>

        <div class="actions"><button class="btn primary" id="postBtn">Post</button></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal (themes only) -->
  <div class="modal-backdrop" id="settingsBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-head">
        <strong>Settings</strong>
        <button class="btn" id="closeSettings" aria-label="Close">✕</button>
      </div>
      <div class="modal-body settings-grid">
        <div>
          <div style="font-weight:700;margin-bottom:6px">Theme</div>
          <div class="swatches" id="themeSwatches"></div>
        </div>
        <div class="actions"><button class="btn" id="saveSettings">Save</button></div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toasts" id="toasts"></div>

  <footer>© 2025 QuoteFeed — by STRAWBER CAR</footer>

  <script>
    // ---------- Utilities ----------
    const $ = (q, ctx=document) => ctx.querySelector(q);
    const el = (t,c) => { const e=document.createElement(t); if(c) e.className=c; return e; };
    const norm = s => (s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const toastsEl = $('#toasts');
    const toast = (msg) => { const t=el('div','toast'); t.textContent=msg; toastsEl.append(t); setTimeout(()=>t.remove(), 3500); };

    // Simple modal helpers (single definitions)
    function showModal(modalEl){ modalEl.style.display='flex'; modalEl.setAttribute('aria-hidden','false'); }
    function hideModal(modalEl){ modalEl.style.display='none'; modalEl.setAttribute('aria-hidden','true'); }

    // ---------- Header clock + Friday countdown ----------
    function updateClock(){
      const d = new Date();
      $('#clock').textContent = d.toLocaleTimeString();
      // Next Friday 00:00 local
      const target = (() => {
        const now = new Date();
        const day = now.getDay(); // 0=Sun..6=Sat; Friday=5
        let diff = 5 - day; if (diff <= 0) diff += 7;
        return new Date(now.getFullYear(), now.getMonth(), now.getDate()+diff, 0,0,0,0);
      })();
      const ms = +target - +d;
      const s  = Math.max(0, Math.floor(ms/1000));
      const dd = Math.floor(s/86400);
      const hh = Math.floor((s%86400)/3600);
      const mm = Math.floor((s%3600)/60);
      const ss = s%60;
      $('#countdown').textContent = `TIME TILL COMMERCE COMMEMORATION DAY — ${dd}d ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    setInterval(updateClock, 1000); updateClock();

    // ---------- Theme handling ----------
    const THEMES = [
      {name:'Purple/Teal',   b1:'#7c4dff', b2:'#00d4ff', bg:'#0e0f14'},
      {name:'Pink/Red',      b1:'#ff4dd2', b2:'#ff4d4d', bg:'#120a0f'},
      {name:'Green/Teal',    b1:'#2bd774', b2:'#00e0c6', bg:'#0a1210'},
      {name:'Orange/Yellow', b1:'#ff8a00', b2:'#ffd200', bg:'#120f0a'},
      {name:'Blue',          b1:'#4da3ff', b2:'#00e0ff', bg:'#0a1016'},
      {name:'Mono',          b1:'#aaaaaa', b2:'#dddddd', bg:'#0b0b0b'}
    ];
    function applyTheme(t){
      document.documentElement.style.setProperty('--brand-1', t.b1);
      document.documentElement.style.setProperty('--brand-2', t.b2);
      document.documentElement.style.setProperty('--bg', t.bg);
    }
    function buildThemeSwatches(){
      const wrap = $('#themeSwatches'); wrap.innerHTML='';
      THEMES.forEach((t, i)=>{
        const s = el('button','swatch'); s.style.background = `linear-gradient(135deg, ${t.b1}, ${t.b2})`;
        s.title = t.name; s.addEventListener('click', ()=>{ applyTheme(t); localStorage.setItem('qf_theme', i); toast(`Theme: ${t.name}`); });
        wrap.append(s);
      });
    }
    buildThemeSwatches();
    const savedThemeIdx = +localStorage.getItem('qf_theme');
    if (!Number.isNaN(savedThemeIdx) && THEMES[savedThemeIdx]) applyTheme(THEMES[savedThemeIdx]);
    $('#settingsBtn').addEventListener('click', ()=> showModal($('#settingsBackdrop')));
    $('#closeSettings').addEventListener('click', ()=> hideModal($('#settingsBackdrop')));
    $('#saveSettings').addEventListener('click', ()=> { toast('Settings saved'); hideModal($('#settingsBackdrop')); });
    $('#settingsBackdrop').addEventListener('click', e=>{ if (e.target===e.currentTarget) hideModal(e.currentTarget); });

    // ---------- Modals ----------
    $('#fab').addEventListener('click', ()=>showModal($('#modalBackdrop')));
    $('#closeModal').addEventListener('click', ()=>hideModal($('#modalBackdrop')));
    $('#modalBackdrop').addEventListener('click', e=>{ if (e.target===e.currentTarget) hideModal(e.currentTarget); });

    // ---------- Rendering ----------
    function renderPost({ username, quote, image_url }) {
      const card = el('div', 'post');
      const head = el('div', 'post-header');
      const name = el('div','username'); name.textContent = username?.startsWith('@') ? username : '@' + username;
      const handle = el('div','handle'); handle.textContent = '• ' + new Date().toLocaleDateString();
      head.append(name, handle);
      const img = new Image(); img.src = image_url; img.alt = 'Post image';
      const q = el('div','post-quote'); q.textContent = `"${quote}"`;
      card.append(head,img,q);
      return card;
    }

    // ---------- CSV parsing & mapping ----------
    function parseCSV(text){
      const rows=[]; let i=0, cur='', inQ=false, row=[];
      const pushCell=()=>{row.push(cur);cur='';};
      for(; i<text.length; i++){
        const ch=text[i], nx=text[i+1];
        if (inQ){
          if (ch === '"' && nx === '"'){ cur+='"'; i++; }
          else if (ch === '"'){ inQ=false; }
          else cur+=ch;
        } else {
          if (ch === '"') inQ=true;
          else if (ch === ','){ pushCell(); }
          else if (ch === '\n'){ pushCell(); rows.push(row.map(s=>s.trim())); row=[]; }
          else if (ch === '\r'){ /* ignore */ }
          else cur+=ch;
        }
      }
      if (cur.length || row.length) { pushCell(); rows.push(row.map(s=>s.trim())); }
      return rows;
    }
    function mapHeaderIndexes(headerRow){
      const headers = headerRow.map(s => (s||'').toLowerCase().replace(/[^a-z0-9]/g,''));
      const find = candidates => { for (const c of candidates){ const i=headers.indexOf(c); if (i!==-1) return i; } return -1; };
      return {
        imageIdx: find(['imageurl','image_url','image']),
        quoteIdx: find(['quote','caption','text']),
        userIdx:  find(['username','user','author','handle','poster'])
      };
    }

    // ---------- Feed & image hash catalog ----------
    const imageCatalog = []; // {url, hash64}

    function addSkeleton(count=3){
      const posts=$('#posts');
      for(let i=0;i<count;i++){
        const card=el('div','post skel');
        const ph1=el('div','post-header'); const ph2=el('div','img skeleton'); const ph3=el('div','post-quote skeleton'); ph3.style.height='48px';
        ph1.innerHTML='<div class="skeleton" style="width:40%;height:18px;border-radius:8px;"></div>';
        card.append(ph1,ph2,ph3); posts.append(card);
      }
    }
    function clearSkeletons(){ document.querySelectorAll('.post.skel').forEach(n=>n.remove()); }

    async function loadFeed(){
      addSkeleton(3);
      try{
        const res = await fetch(CONFIG.SHEET_CSV_URL, {cache:'no-store'});
        const csv = await res.text();
        const rows = parseCSV(csv).filter(r => r.length > 0);
        if (!rows.length) throw new Error('CSV empty');
        const header = rows[0];
        const { imageIdx, quoteIdx, userIdx } = mapHeaderIndexes(header);
        if (imageIdx===-1 || quoteIdx===-1 || userIdx===-1) throw new Error('Missing required columns');

        const data = rows.slice(1).map(r => ({
          image_url: r[imageIdx],
          quote:     r[quoteIdx],
          username:  r[userIdx]
        })).filter(x => x.image_url && x.quote && x.username);

        clearSkeletons();
        const posts = $('#posts'); posts.innerHTML='';
        imageCatalog.length = 0;
        for (const p of data) {
          posts.appendChild(renderPost(p));
          try {
            const h = await hashImageFromURL(p.image_url);
            if (h) imageCatalog.push({ url: p.image_url, hash64: h });
          } catch(_) { /* ignore */ }
        }
        // (Newest at bottom; reverse() if you want newest first.)
      }catch(e){
        clearSkeletons();
        const err=el('div','post'); const msg=el('div','post-quote');
        msg.textContent='Could not load the CSV. Check Publish-to-web URL and header names.';
        err.append(el('div','post-header').appendChild(document.createTextNode('Load Error')), msg);
        $('#posts').append(err);
        console.error(e);
      }
    }

    // ---------- Perceptual hash (aHash, 8x8) ----------
    function aHashFromCanvas(ctx, w=8, h=8){
      const imgData = ctx.getImageData(0,0,w,h).data;
      const gray = [];
      for (let i=0;i<imgData.length;i+=4){
        const r=imgData[i], g=imgData[i+1], b=imgData[i+2];
        gray.push(0.299*r + 0.587*g + 0.114*b);
      }
      const avg = gray.reduce((a,b)=>a+b,0)/gray.length;
      const bits = gray.map(v => v >= avg ? 1 : 0);
      return bits.join('');
    }
    function bitStringToBase64(bits){
      const bytes = new Uint8Array(8);
      for (let i=0;i<64;i++){
        const bIndex = i>>3, bitPos = 7 - (i & 7);
        if (bits[i]==='1') bytes[bIndex] |= (1<<bitPos);
      }
      let binary = '';
      bytes.forEach(b => binary += String.fromCharCode(b));
      return btoa(binary);
    }
    function base64ToBitString(b64){
      const bin = atob(b64);
      const out = [];
      for (let i=0;i<bin.length;i++){
        const v = bin.charCodeAt(i);
        for (let bit=7; bit>=0; bit--){
          out.push(((v>>bit)&1) ? '1' : '0');
        }
      }
      return out.join('');
    }
    function hammingDistanceHash64(a64, b64){
      const aBits = base64ToBitString(a64), bBits = base64ToBitString(b64);
      let d=0; for (let i=0;i<64;i++) if (aBits[i]!==bBits[i]) d++;
      return d;
    }

    function hashImageElement(img, size=8){
      return new Promise(resolve => {
        const c = document.createElement('canvas');
        c.width = size; c.height = size;
        const ctx = c.getContext('2d', { willReadFrequently: true });
        ctx.drawImage(img, 0, 0, size, size);
        const bits = aHashFromCanvas(ctx, size, size);
        resolve(bitStringToBase64(bits));
      });
    }
    function hashImageFromURL(url, size=8){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = async () => {
          try { const h = await hashImageElement(img, size); resolve(h); }
          catch(e){ reject(e); }
        };
        img.onerror = reject;
        img.src = url;
      });
    }
    function hashFromFile(file, size=8){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = async () => {
            try { const h = await hashImageElement(img, size); resolve(h); }
            catch(e){ reject(e); }
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function findSimilarImageForFile(file){
      try{
        const h = await hashFromFile(file);
        let best = null, bestD = Infinity;
        for (const item of imageCatalog){
          const d = hammingDistanceHash64(h, item.hash64);
          if (d < bestD){ bestD = d; best = item; }
        }
        if (best && bestD <= CONFIG.DUP_HAMMING_THRESHOLD) return best;
        return null;
      }catch(e){ return null; }
    }

    // ---------- Upload + Submit ----------
    async function uploadToCloudinary(file){
      const url = `https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY.cloudName}/image/upload`;
      const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', CONFIG.CLOUDINARY.uploadPreset);
      const res = await fetch(url, { method:'POST', body: fd });
      if (!res.ok) throw new Error('Cloudinary upload failed');
      return await res.json();
    }
    async function submitToGoogleForm({image_url, quote, username}){
      const params = new URLSearchParams();
      params.set(CONFIG.FORM_FIELDS.image_url, image_url);
      params.set(CONFIG.FORM_FIELDS.quote, quote);
      params.set(CONFIG.FORM_FIELDS.username, username);
      await fetch(CONFIG.FORM_ACTION, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: params.toString()
      });
    }

    // ---------- Post modal logic ----------
    const imageInput = $('#imageFile');
    const preview = $('#preview');
    const dupBox = $('#dupBox');
    const dupPreview = $('#dupPreview');
    const dupUseBtn = $('#dupUse');
    const dupCancelBtn = $('#dupCancel');

    let suggestedExistingURL = null;

    imageInput.addEventListener('change', async () => {
      dupBox.style.display = 'none';
      suggestedExistingURL = null;
      const f = imageInput.files[0];
      if (!f) { preview.src=''; preview.style.display='none'; return; }
      const url = URL.createObjectURL(f);
      preview.src = url; preview.style.display='block';

      // Find similar existing image
      const match = await findSimilarImageForFile(f);
      if (match){
        suggestedExistingURL = match.url;
        dupPreview.src = match.url;
        dupBox.style.display = 'block';
      }
    });

    dupCancelBtn.addEventListener('click', () => {
      suggestedExistingURL = null;
      dupBox.style.display = 'none';
      toast('Okay, we’ll use the new upload.');
    });
    dupUseBtn.addEventListener('click', () => {
      imageInput.value = '';
      preview.style.display='none';
      dupBox.style.display = 'none';
      toast('Using existing image URL.');
    });

    $('#postBtn').addEventListener('click', async () => {
      const username = $('#username').value.trim();
      const quote = $('#quote').value.trim();
      const file = imageInput.files[0];

      if (!username || !quote) { toast('Please fill username and quote.'); return; }

      try{
        let finalURL = suggestedExistingURL;
        if (!finalURL){
          if (!file){ toast('Choose an image or accept the suggested one.'); return; }
          toast('Uploading image…');
          const up = await uploadToCloudinary(file);
          finalURL = up.secure_url;
        }
        toast('Submitting post…');
        await submitToGoogleForm({ image_url: finalURL, quote, username });

        // Optimistic UI
        $('#posts').prepend(renderPost({ image_url: finalURL, quote, username }));
        // Update catalog with new image hash if it came from a new upload
        if (!suggestedExistingURL && file){
          try {
            const h = await hashFromFile(file);
            imageCatalog.push({ url: finalURL, hash64: h });
          } catch(_) {}
        }

        toast('Posted!');
        // reset & close
        $('#username').value=''; $('#quote').value=''; imageInput.value=''; preview.style.display='none';
        suggestedExistingURL = null; dupBox.style.display='none';
        hideModal($('#modalBackdrop'));
      }catch(e){
        console.error(e); toast('Post failed. Check Cloudinary/Form config.');
      }
    });

    // Esc to close any open modal
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        const mb = $('#modalBackdrop'), sb = $('#settingsBackdrop');
        if (mb.getAttribute('aria-hidden')==='false') hideModal(mb);
        if (sb.getAttribute('aria-hidden')==='false') hideModal(sb);
      }
    });

    // Initial load
    loadFeed();
  </script>
</body>
</html>
